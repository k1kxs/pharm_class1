Скорректированный План с Акцентом на Сохранение Фронтенда (с чекбоксами):

(Пункты с пометкой [АКЦЕНТ] требуют особого внимания для сохранения внешнего вида и функционала)

I. Настройка Backend (server/) - Без изменений по сути
Эта часть касается только сервера и замены MongoDB на SQLite/Knex. Все шаги остаются необходимыми.

[ ] [АКЦЕНТ] Сохранение API контракта: При рефакторинге контроллеров и маршрутов стремиться к тому, чтобы структура ответов API оставалась максимально идентичной старой. Новый бэкенд должен отдавать данные в том же формате, который ожидает фронтенд (дерево или плоский список).
1. Установка зависимостей
[ ] Установить необходимые пакеты для работы с SQLite и Knex.js:
Bash

cd server
npm install sqlite3 knex --save
npm install @types/sqlite3 @types/knex --save-dev
# Удалить зависимости MongoDB/Mongoose (опционально, можно позже)
# npm uninstall mongoose @types/mongoose
2. Конфигурация Knex.js
[ ] Создать файл конфигурации knexfile.ts в корне папки server/.
[ ] Обновить или создать файл .env в папке server/ с путем к файлу БД (DB_FILEPATH=./database.sqlite) и секретом JWT (JWT_SECRET=...).
[ ] Создать файл для инициализации и экспорта экземпляра Knex server/src/db/knex.ts.
3. Создание миграций базы данных
[ ] Создать необходимые папки src/db/migrations и src/db/seeds.
[ ] Создать миграцию для таблицы users (npx knex migrate:make create_users_table ...).
[ ] Заполнить файл миграции *_create_users_table.ts (id, username, password_hash, role, timestamps).
[ ] Создать миграцию для таблицы classification_items (npx knex migrate:make create_classification_items_table ...).
[ ] Заполнить файл миграции *_create_classification_items_table.ts (id, name, description, parent_id, order_index, timestamps).
[ ] Применить миграции (npx knex migrate:latest ... или через скрипт npm).
[ ] Добавить скрипты для миграций/сидов в server/package.json.
4. Реализация Репозиториев
[ ] Создать папку server/src/repositories.
[ ] Создать/адаптировать server/src/repositories/UserRepository.ts (методы findByUsername, findById, createUser с хешированием bcrypt).
[ ] Создать/адаптировать server/src/repositories/ClassificationRepository.ts (методы getAllItems, findById, createItem, updateItem, deleteItem, updateOrder для DnD).
[ ] (Опционально) Создать файл server/src/types.ts для общих интерфейсов (User, ClassificationItem).
5. Рефакторинг Контроллеров
[ ] Создать папку server/src/controllers.
[ ] Создать/адаптировать server/src/controllers/AuthController.ts (логика login с использованием UserRepository, bcrypt, jwt).
[ ] Создать/адаптировать server/src/controllers/ClassificationController.ts (методы getAll, create, update, delete, reorder, exportPdf с использованием ClassificationRepository).
[ ] [АКЦЕНТ] Убедиться, что getAll возвращает данные в формате, ожидаемом фронтендом (плоский список или дерево, построенное функцией типа buildTree).
6. Рефакторинг Маршрутов (Routes)
[ ] Создать папку server/src/routes.
[ ] Создать/адаптировать server/src/routes/auth.ts (используя AuthController).
[ ] Создать/адаптировать server/src/routes/classification.ts (публичный GET / и защищенные POST /, PUT /:id, DELETE /:id, PUT /reorder, используя ClassificationController и middleware).
[ ] Создать/адаптировать server/src/routes/pdf.ts (если PDF генерируется на сервере, используя ClassificationController).
7. Рефакторинг Middleware
[ ] Создать папку server/src/middleware.
[ ] Создать/адаптировать server/src/middleware/auth.ts (функции verifyToken для проверки JWT и isAdmin для проверки роли).
8. Обновление точки входа (server.ts)
[ ] Переместить/обновить server/src/server.ts (настройка Express, CORS, middleware, подключение маршрутов, запуск сервера).
[ ] Обновить server/package.json (скрипты start, dev, build).
[ ] Обновить server/tsconfig.json (настройки компиляции, outDir, rootDir, paths).
[ ] Установить ts-node-dev (если еще не установлен).
II. Адаптация Frontend (client/) - [АКЦЕНТ] Минимальные изменения
Основная цель: Заставить существующие компоненты работать с новым бэкендом, изменив только способ получения/отправки данных и типизацию, не переписывая компоненты, стили или основную логику.

1. Обновление типов данных
[ ] Обновить интерфейсы TypeScript (src/types/classification.ts и т.д.) для точного соответствия структуре данных, возвращаемой API.
2. Настройка API Service / React Query
[ ] Обновить функции/хуки (useQuery, useMutation) для вызова API эндпоинтов.
[ ] [АКЦЕНТ] Убедиться, что данные из useQuery имеют ту же структуру, которую ожидают компоненты. Проверить через console.log или React DevTools.
3. Рефакторинг Компонентов - [АКЦЕНТ] Минимизировать!
[ ] [АКЦЕНТ] Не переписывать компоненты с нуля! Адаптировать существующие.
[ ] [АКЦЕНТ] Изменения внутри компонентов должны касаться только получения/использования данных. Логика рендеринга (JSX) и стили (Tailwind, Styled Components) должны остаться прежними.
[ ] Если удалялись старые компоненты, убедиться, что новые полностью воспроизводят их внешний вид и поведение.
[ ] Адаптировать модальные окна/формы: изменить только вызовы мутаций при сохранении.
4. Реализация Drag-and-Drop (DnD)
[ ] [АКЦЕНТ] Логика настройки DnD Kit и визуальное представление не должны меняться.
[ ] Адаптировать только обработчик onDragEnd: корректное определение нового положения, формирование payload для API, вызов мутации reorderClassificationItems.
5. Адаптация Rich Text Editor (React Quill)
[ ] [АКЦЕНТ] Интеграция ReactQuill и его внешний вид не должны меняться.
[ ] Адаптировать только сохранение: вызов правильной мутации updateClassificationItem с актуальным содержимым.
6. Адаптация Аутентификации
[ ] [АКЦЕНТ] Внешний вид страницы логина, защита роутов не должны меняться.
[ ] Обновить только вызов функции loginUser и обработку ответа.
7. Реализация Экспорта PDF
[ ] [АКЦЕНТ] Внешний вид кнопки экспорта не должен меняться.
[ ] Адаптировать только механизм (вызов jspdf с правильными данными или переход по ссылке на API).
III. Тестирование - [АКЦЕНТ] Важно для UI!
[ ] [АКЦЕНТ] Визуальное тестирование: Тщательно проверить внешний вид всех страниц и компонентов. Сравнить с тем, как было до миграции.
[ ] [АКЦЕНТ] Тестирование функциональности: Проверить все пользовательские сценарии (просмотр, логин/логаут, CRUD, DnD, PDF экспорт).
[ ] Написать/обновить unit/интеграционные тесты для бэкенда.
[ ] (Опционально) Написать/обновить тесты для фронтенда.
IV. Миграция данных (Опционально)
[ ] Если нужно, написать и запустить скрипт для переноса данных из MongoDB в SQLite.
V. Деплой и Завершение - [АКЦЕНТ]
[ ] Добавить server/database.sqlite (или путь из .env) в .gitignore.
[ ] [АКЦЕНТ] Настроить деплой на российском хостинге: корректная раздача статики фронтенда (client/build), проксирование на бэкенд (/api/*), права на файл database.sqlite, переменные окружения.
[ ] Настроить регулярное резервное копирование database.sqlite.
[ ] Провести финальное тестирование на развернутом приложении.
